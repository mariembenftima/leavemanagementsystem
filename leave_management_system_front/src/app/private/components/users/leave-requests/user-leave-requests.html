<app-user-nav-bar></app-user-nav-bar>

<div class="app-shell">
  <div class="shell-content">
    <app-user-side-bar></app-user-side-bar>

    <div class="app-container">
      <div class="page-header">
        <h1 class="page-title">Leave Request</h1>
        <p class="page-subtitle">Submit your leave request with all required details</p>
      </div>

      <div class="container">
        <form [formGroup]="leaveRequestForm" (ngSubmit)="onSubmit()" class="leave-form fade-in">
          <div class="form-section">
            <h3 class="section-title">Employee Information</h3>

            <div *ngIf="isLoadingUser" class="employee-info-card">
              <p>Loading user info...</p>
            </div>

            <div *ngIf="!isLoadingUser && currentEmployee" class="employee-info-card slide-in">
              <div class="employee-avatar">
                <img [src]="currentEmployee.avatarUrl || 'https://img.icons8.com/ios/100/000000/user.png'"
                  alt="Employee Avatar" class="avatar-image" />
              </div>
              <div class="employee-details">
                <h4 class="employee-name">
                  {{ currentEmployee.fullname || currentEmployee.fullname }}
                </h4>
                <p class="employee-id">ID: {{ currentEmployee.userId || 'N/A' }}</p>
                <p class="employee-dept">
                  {{ currentEmployee.team?.name || currentEmployee.department || 'No team assigned' }}
                </p>
              </div>
            </div>

          </div>


          <div class="form-section">
            <h3 class="section-title">Leave Details</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="type" class="form-label required">Leave Type</label>
                <select id="type" formControlName="type" class="form-select" [class.error]="isFieldInvalid('type')">
                  <option value="" disabled>Select leave type</option>
                  <option *ngFor="let leaveType of leaveTypes" [value]="leaveType.value">
                    {{ leaveType.label }}
                  </option>
                </select>
                <div *ngIf="getFieldError('type')" class="error-message">
                  {{ getFieldError('type') }}
                </div>
              </div>

              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="halfDay" formControlName="halfDay" (change)="onHalfDayToggle()" />
                  <label for="halfDay">Half Day Leave</label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="startDate" class="form-label required">Start Date</label>
                <input type="date" id="startDate" formControlName="startDate" class="form-control" [min]="minDate"
                  [class.error]="isFieldInvalid('startDate')" (change)="onStartDateChange()" />
                <div *ngIf="getFieldError('startDate')" class="error-message">
                  {{ getFieldError('startDate') }}
                </div>
              </div>

              <div class="form-group">
                <label for="endDate" class="form-label required">End Date</label>
                <input type="date" id="endDate" formControlName="endDate" class="form-control"
                  [min]="leaveRequestForm.get('startDate')?.value || minDate"
                  [class.error]="isFieldInvalid('endDate')" />
                <div *ngIf="getFieldError('endDate')" class="error-message">
                  {{ getFieldError('endDate') }}
                </div>
              </div>
            </div>

            <div class="form-row single">
              <div class="form-group">
                <label for="reason" class="form-label required">Reason for Leave</label>
                <textarea id="reason" formControlName="reason" class="form-control" rows="4"
                  placeholder="Please provide a detailed reason for your leave request..."
                  [class.error]="isFieldInvalid('reason')"></textarea>
                <div *ngIf="getFieldError('reason')" class="error-message">
                  {{ getFieldError('reason') }}
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="emergencyContact" class="form-label">Emergency Contact</label>
                <input type="text" id="emergencyContact" formControlName="emergencyContact" class="form-control"
                  placeholder="Emergency contact number" />
              </div>

              <div class="form-group">
                <label for="managerEmail" class="form-label">Manager Email</label>
                <input type="email" id="managerEmail" formControlName="managerEmail" class="form-control"
                  placeholder="manager@company.com" [class.error]="isFieldInvalid('managerEmail')" />
                <div *ngIf="getFieldError('managerEmail')" class="error-message">
                  {{ getFieldError('managerEmail') }}
                </div>
              </div>
            </div>
          </div>

          <div class="form-section" *ngIf="getSelectedLeaveType() && calculateTotalDays() > 0">
            <h3 class="section-title">Leave Summary</h3>
            <div class="leave-summary slide-in">
              <div class="summary-grid">
                <div class="summary-item">
                  <p class="summary-label">Leave Type</p>
                  <p class="summary-value">{{ getSelectedLeaveType()?.label }}</p>
                </div>
                <div class="summary-item">
                  <p class="summary-label">Total Days</p>
                  <p class="summary-value">{{ calculateTotalDays() }}</p>
                </div>
                <div class="summary-item">
                  <p class="summary-label">Date Range</p>
                  <p class="summary-value">{{ formatDateRange(leaveRequestForm.get('startDate')?.value,
                    leaveRequestForm.get('endDate')?.value) }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">Attachments (Optional)</h3>

            <div class="file-upload-area" (click)="fileInput.click()" (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
              <div class="file-upload-icon">ðŸ“Ž</div>
              <p class="file-upload-text">Click to upload or drag and drop files here</p>
              <p class="file-upload-hint">PDF, DOC, DOCX, JPG, PNG (Max 5MB each)</p>
            </div>

            <input #fileInput type="file" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
              (change)="onFileSelect($event)" class="sr-only" />

            <div class="file-list" *ngIf="attachedFiles.length > 0">
              <div class="file-item fade-in" *ngFor="let file of attachedFiles; let i = index">
                <div class="file-info">
                  <span class="file-icon">ðŸ“„</span>
                  <div class="file-details">
                    <h5>{{ file.name }}</h5>
                    <p>{{ formatFileSize(file.size) }}</p>
                  </div>
                </div>
                <button type="button" class="file-remove" (click)="removeFile(i)" title="Remove file">
                  Ã—
                </button>
              </div>
            </div>
          </div>

          <div class="validation-summary" *ngIf="hasFormErrors">
            <h4>Please fix the following errors:</h4>
            <ul>
              <li *ngIf="isFieldInvalid('type')">Leave type is required</li>
              <li *ngIf="isFieldInvalid('startDate')">Start date is required</li>
              <li *ngIf="isFieldInvalid('endDate')">End date is required and must be after start date</li>
              <li *ngIf="isFieldInvalid('reason')">Reason for leave is required</li>
              <li *ngIf="isFieldInvalid('managerEmail')">Please enter a valid email address</li>
            </ul>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onCancel()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isSubmitting" [class.loading]="isSubmitting">
              <span *ngIf="!isSubmitting">Submit Request</span>
              <span *ngIf="isSubmitting">Submitting...</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>